# MongoDB with Simple Replica Set and No Mandatory Authentication (Dockerfile)

**NOTE:** this solution using Dockerfile does not enable mandatory authentication when connecting to database, as it's not possible to set up the keyfile without Docker Compose.

Connection string: `mongodb://localhost:27017/?replicaSet=rs0`

## Locally

1.  Create a new Docker Hub repository [rebelodocker/spring-mongodb-demo](https://hub.docker.com/)

2.  There is an issue when running mongodb with replica set using Docker (at least for Windows), that it's not possible to connect to database after its creation. The workaround found is adding the following mapping to the hosts file _C:\Windows\System32\drivers\etc\hosts_:

    ```
    127.0.0.1 mongo1
    ```

3.  Create a Dockerfile with the content:

    ```
    # Build mongodb
    FROM mongo:5

    # Specify the command to run MongoDB with replica set configuration
    CMD ["mongod", "--replSet", "rs0", "--bind_ip", "localhost,mongo1"]
    ```

4.  Create the docker image by running the command using the Git Bash terminal where the Dockerfile is located:

    `$ docker buildx build --platform linux/amd64 -t rebelodocker/spring-mongodb-demo:mongodb .`

5.  Push the image to Docker Hub repository created earlier:

    `$ docker push rebelodocker/spring-mongodb-demo:mongodb`

6.  Create a new network:

    `$ docker network create erebelo_cluster`

7.  Create the new volumes:

    `$ docker volume create mongo1_data`

    `$ docker volume create mongo1_configdb`

8.  Get the **Environment Variables** provided by the filename **.env** in the /scripts folder and change the values of the following fields: _ADMIN_PWD_, _ROOT_PWD_, and _REGULAR_PWD_

9.  Create and start container:

    `$ docker run -d --name mongo1 -p 27017:27017 --restart always --network erebelo_cluster -v mongo1_data:/data/db -v mongo1_configdb:/data/configdb rebelodocker/spring-mongodb-demo:mongodb`

10. Set the executable permission for the file **win-setup.sh** (creates replica set, database users, and collections) and run it in the directory where the script and the .env are:

    NOTE: use **win-setup.sh** for Windows and **linux-setup.sh** for Linux SO.

    `$ cd ../scripts`

    `$ chmod +x win-setup.sh`

    `$ ./win-setup.sh`

11. Testing manually (optional):

    `$ winpty docker exec -it mongo1 mongosh # remove 'winpty' prefix if running on Linux`

    `$ use admin`

    `$ db.auth("root", <ROOT_PASSWORD>)`

    `$ show users`

    `$ rs.status()`

    `$ exit`

12. When wanting to clean mongo docker (container, image, and volumes), set the executable permission to the **cleanup.sh** file and run it (optional):

    `$ chmod +x cleanup.sh`

    `$ ./cleanup.sh`

## AWS EC2 via SSH

1. Connect to EC2 via Git Bash (enter the public ssh password):

   `$ ssh ec2-user@<EC2_INSTANCE_IPV4_ADDRESS>`

2. Perform a similar approach as previously described in step **#2** by adding the **_mongo1_** mapping to the hosts file, but now for Linux OS:

   - Edit the /etc/hosts:

     `$ sudo vim /etc/hosts`

     `$ i`

   - Add **_mongo1_** to the end of the mapping for host **_127.0.1.1_**. The file should look like:

     ```
     127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 mongo1
     ::1 localhost6 localhost6.localdomain6
     ```

   - Exit and save by pressing the keys below:

     `$ Esc`

     `$ :wq`

3. Pull docker image:

   `$ docker pull rebelodocker/spring-mongodb-demo:mongodb`

4. Perform steps **#6**, **#7**, **#8**, **#9**, and **#10** described earlier by using the GitHub repository to get all required files

5. Connect to AWS EC2 **_mongo1_** container by local **MongoDB Compass IDE**:

   - Use the following connection string:

     `mongodb://localhost:27017/?replicaSet=rs0`

   - In **Authentication** tab, leave the **None** option set
   - In **Proxy/SSH** tab, leave the **SSH with Identity File** option set and fill the fields as follow:
     ```
     SSH Hostname: <EC2_INSTANCE_IPV4_ADDRESS>
     SSH Port: 22
     SSH Username: ec2-user
     SSH Identity File: get the id_rsa private file generated by the SSH connection
     SSH Passphrase: <SSH_PASSWORD>
     ```

---

Now, if applicable, perform one of the approaches from **java-app** described in README.md to deploy a **Java App** instance.
